# Mobile Shop POS - Implementation Tasks

## Phase 1: Database Foundation ✅ COMPLETED

### Task 1.1: Environment Configuration ✅
- [x] Create `.env.example` file
- [x] Modify `database.php` to load .env variables
- [x] Change database driver from PDO to mysqli
- [x] Set timezone to Asia/Karachi in `index.php`
- [x] Update character set to utf8mb4

**Files Modified:**
- `application/config/database.php`
- `index.php`
- `.env.example` (created)

**Verification:**
```bash
php -r "echo date_default_timezone_get();" # Should show Asia/Karachi
```

---

### Task 1.2: Database Schema Migration ✅
- [x] Create migration SQL file
- [x] Modify `items` table (add columns)
- [x] Create `item_serials` table
- [x] Create `customers` table
- [x] Create `customer_ledger` table
- [x] Create `trade_ins` table
- [x] Modify `transactions` table
- [x] Create `inventory_available` view
- [x] Create `profit_report` view

**Files Created:**
- `database/migrations/001_phase1_mobile_shop_schema.sql`

**Verification:**
```sql
SHOW TABLES;
DESCRIBE item_serials;
SELECT * FROM inventory_available LIMIT 1;
```

---

## Phase 2: Inventory Management Module

### Task 2.1: Modify Item Model
**Priority:** P0  
**Estimated Time:** 4 hours  
**Dependencies:** Phase 1

**Subtasks:**
- [x] Add `addWithType()` method to handle both standard and serialized
- [x] Add `addSerialNumber()` method for bulk IMEI insert
- [x] Add `getAvailableSerials()` method
- [x] Add `lockSerial()` method
- [x] Add `releaseSerial()` method
- [x] Add `markSerialSold()` method
- [x] Add `getSerialInfo()` method
- [x] Modify `getAll()` to join with inventory_available view

**Files to Modify:**
- `application/models/Item.php`

**Acceptance Criteria:**
- Can insert item with item_type field
- Can bulk insert IMEI numbers
- Can retrieve available IMEIs for an item
- Can lock/unlock IMEI status

**Test Cases:**
```php
// Test 1: Add standard item
$item_id = $this->item->addWithType([
    'name' => 'Samsung Charger',
    'code' => 'SAMCHG01',
    'item_type' => 'standard',
    'quantity' => 50
]);

// Test 2: Add serialized item with IMEIs
$item_id = $this->item->addWithType([
    'name' => 'iPhone 13',
    'code' => 'IP13',
    'item_type' => 'serialized'
]);
$this->item->addSerialNumber($item_id, [
    ['imei' => '123456789012345', 'color' => 'Black', 'cost_price' => 230000]
]);
```

---

### Task 2.2: Update Items Controller
**Priority:** P0  
**Estimated Time:** 6 hours  
**Dependencies:** Task 2.1

**Subtasks:**
- [x] Modify `add()` method to handle item_type
- [x] Add validation for IMEI format (15 digits)
- [x] Add IMEI uniqueness check
- [x] Handle IMEI array from POST data
- [x] Update event logging for serialized items
- [x] Modify `edit()` method to handle new fields
- [x] Add `getItemSerials()` AJAX method
- [x] Add `checkImeiAvailability()` AJAX method
- [x] Implement automatic item code generation (ALWAYS auto-generate)



  - Generate unique code format: `{CATEGORY_PREFIX}{YYYYMMDD}{SEQUENCE}` (e.g., MOB20241225001)
  - Category prefixes: MOB (mobile), ACC (accessory), OTH (other)
  - Auto-increment sequence number per day (resets daily: 001, 002, 003...)
  - Check for uniqueness and handle collisions
  - Remove itemCode from required validation (system generates it)
  - Add `generateItemCode()` helper method in Items controller
  - Code generation happens automatically in add() method before insert

**Files to Modify:**
- `application/controllers/Items.php`

**Acceptance Criteria:**
- Form validation works for both item types
- IMEI numbers validated and stored correctly
- Duplicate IMEI prevented
- Event log records IMEI count
- Item codes ALWAYS auto-generated (no manual entry)
- Generated codes follow consistent format
- No duplicate codes possible

---

### Task 2.3: Create Inventory UI
**Priority:** P0  
**Estimated Time:** 8 hours  
**Dependencies:** Task 2.2

**Subtasks:**
- [x] Add "Product Type" radio buttons to add item form


- [x] Add "Category" dropdown (Mobile, Accessory, Other)

- [x] Add "Brand" and "Model" fields

- [x] Add "Warranty Months" field

- [x] Create dynamic IMEI input fields (show/hide based on type)

- [x] Add "Add More IMEI" button

- [x] Implement IMEI auto-focus after scan

- [x] Update items list table to show item_type and category

- [x] Add filter by category

- [x] Add "View IMEIs" button for serialized items


- [x] Remove/hide item code input field from add item form

  - Item code is auto-generated by system
  - Show read-only field displaying "Auto-generated" or generated code after save
  - Display generated code in success message after item creation

**Files to Modify:**
- `application/views/items/items.php`
- `application/views/items/itemslisttable.php`

**Files to Create:**
- `public/js/items.js`

**Acceptance Criteria:**
- UI toggles between standard and serialized modes
- IMEI fields appear only for serialized items
- Quantity field appears only for standard items
- Can add multiple IMEI entries dynamically
- Barcode scanner input works seamlessly
- Item code field is hidden/read-only (auto-generated by system)
- Generated code displayed after successful item creation

---

### Task 2.4: IMEI Management Screen
**Priority:** P1  
**Estimated Time:** 4 hours  
**Dependencies:** Task 2.3

**Subtasks:**
- [x] Create modal to view all IMEIs for an item


- [x] Show IMEI status (available, sold, returned, etc.)

- [x] Add filter by status

- [x] Show sold date and transaction ref for sold IMEIs

- [x] Add "Mark as Defective" option

- [x] Add notes field for each IMEI



**Files to Create:**
- `application/views/items/imei_list_modal.php`

**Acceptance Criteria:**
- Can view all IMEIs for a serialized item
- Status displayed correctly
- Can mark IMEI as defective with reason

---

## Phase 3: POS Transaction Module

### Task 3.1: Implement IMEI Search
**Priority:** P0  
**Estimated Time:** 4 hours  
**Dependencies:** Task 2.1

**Subtasks:**
- [x] Add `searchByImei()` method to Transactions controller


- [x] Query item_serials table for exact IMEI match

- [x] Check status = 'available'

- [x] Return item details with cost_price for profit calculation

- [x] Handle "not found" and "already sold" cases

- [x] Add AJAX endpoint



**Files to Modify:**
- `application/controllers/Transactions.php`

**Acceptance Criteria:**
- IMEI search returns correct item
- Returns error if IMEI not found
- Returns error if IMEI already sold
- Response includes cost_price for profit calc

**Test Cases:**
```javascript
// Test 1: Valid IMEI
$.get('/transactions/searchByImei?imei=123456789012345', function(data) {
    // Should return status: 1 with item details
});

// Test 2: Invalid IMEI
$.get('/transactions/searchByImei?imei=999999999999999', function(data) {
    // Should return status: 0 with error message
});
```

---

### Task 3.2: Implement Cart Management ✅
**Priority:** P0  
**Estimated Time:** 6 hours  
**Dependencies:** Task 3.1

**Subtasks:**
- [x] Create session-based cart storage
- [x] Add `addToCart()` AJAX method
- [x] Lock IMEI when added to cart (status = 'reserved')
- [x] Add `removeFromCart()` AJAX method
- [x] Release IMEI when removed from cart
- [x] Add `clearCart()` method
- [x] Calculate cart totals (subtotal, discount, VAT, grand total)
- [x] Handle cart timeout (release IMEIs after 30 minutes)

**Files to Modify:**
- `application/controllers/Transactions.php`
- `application/libraries/Genlib.php` (add cart helper methods)

**Acceptance Criteria:**
- Items added to session cart
- IMEI locked when added
- IMEI released when removed
- Cart persists across page refreshes
- Cart auto-clears after timeout

---

### Task 3.3: Update POS UI ✅
**Priority:** P0  
**Estimated Time:** 10 hours  
**Dependencies:** Task 3.2

**Subtasks:**
- [x] Add IMEI search field to POS screen
- [x] Implement real-time search (on Enter key)
- [x] Display cart items with IMEI (if serialized)
- [x] Add remove button for each cart item
- [x] Show subtotal, discount, VAT, grand total
- [x] Add discount percentage input
- [x] Add VAT percentage input
- [x] Update totals in real-time
- [x] Add customer search/select dropdown
- [x] Display customer current balance
- [x] Add payment method dropdown (Cash, POS, Credit, Partial)
- [x] Show/hide payment fields based on method
- [x] Add "Trade-In Mode" toggle button (placeholder for next task)

**Files to Modify:**
- `application/views/transactions/transactions.php`

**Files to Create:**
- `public/js/pos.js`

**Acceptance Criteria:**
- IMEI search works and adds to cart
- Cart displays correctly with IMEI info
- Totals calculate correctly
- Customer balance displayed
- Payment method changes UI accordingly

---

### Task 3.4: Implement Trade-In System ✅
**Priority:** P1  
**Estimated Time:** 6 hours  
**Dependencies:** Task 3.3

**Subtasks:**
- [x] Create trade-in form modal
- [x] Add fields: brand, model, IMEI (optional), condition, value
- [x] Add `processTradeIn()` method to controller
- [x] Validate trade-in value doesn't exceed sale total
- [x] Insert into trade_ins table
- [x] If IMEI provided, add to item_serials with status 'traded_in'
- [x] Deduct trade-in value from payment amount
- [x] Display trade-in on receipt (will be implemented in transaction processing)

**Files to Modify:**
- `application/controllers/Transactions.php`
- `application/views/transactions/transactions.php`

**Files to Create:**
- `application/views/transactions/trade_in_modal.php`

**Acceptance Criteria:**
- Trade-in form captures all required data
- Trade-in value deducted from total
- Trade-in recorded in database
- Trade-in appears on receipt

---

### Task 3.5: Implement Profit Calculation ✅
**Priority:** P1  
**Estimated Time:** 4 hours  
**Dependencies:** Task 3.2

**Subtasks:**
- [x] Add `calculateProfit()` method
- [x] For serialized items: profit = selling_price - cost_price
- [x] For standard items: profit = (selling_price - unitPrice) * quantity
- [x] Calculate total profit for transaction
- [x] Store in transactions.profit_amount (will be implemented in transaction processing)
- [x] Exclude VAT and discount from profit calculation

**Files to Modify:**
- `application/controllers/Transactions.php`

**Acceptance Criteria:**
- Profit calculated correctly for both item types
- Profit stored in database
- Profit excludes VAT and discount

---

### Task 3.6: Update Transaction Processing ✅
**Priority:** P0  
**Estimated Time:** 8 hours  
**Dependencies:** Task 3.1, 3.2, 3.4, 3.5

**Subtasks:**
- [x] Modify `nso_()` method to handle new fields (created new `processCartTransaction()` method)
- [x] Validate IMEI availability before processing
- [x] Mark IMEIs as sold
- [x] Store IMEI numbers in transactions.imei_numbers (comma-separated)
- [x] Store profit_amount
- [x] Handle payment_status (paid, partial, credit)
- [x] Store paid_amount and credit_amount
- [x] Link customer_id if credit sale
- [x] Process trade-in if applicable
- [x] Update customer balance if credit (placeholder for Phase 4)
- [x] Create customer_ledger entry (placeholder for Phase 4)
- [x] Generate receipt with IMEI and warranty info

**Files to Modify:**
- `application/controllers/Transactions.php`
- `application/models/Transaction.php`

**Acceptance Criteria:**
- Transaction saves with all new fields
- IMEIs marked as sold
- Customer balance updated correctly
- Ledger entry created
- Receipt includes IMEI and warranty

---

## Phase 4: Customer Credit (Khata) Module

### Task 4.1: Create Customer Model ✅
**Priority:** P1  
**Estimated Time:** 4 hours  
**Dependencies:** Phase 1

**Subtasks:**
- [x] Create `Customer.php` model
- [x] Add `add()` method
- [x] Add `getAll()` method with pagination
- [x] Add `getByPhone()` method
- [x] Add `getById()` method
- [x] Add `updateBalance()` method
- [x] Add `getLedger()` method
- [x] Add `recordPayment()` method
- [x] Add `checkCreditLimit()` method
- [x] Add `search()` method

**Files to Create:**
- `application/models/Customer.php`

**Acceptance Criteria:**
- All CRUD operations work
- Balance updates correctly
- Credit limit validation works

---

### Task 4.2: Create Customers Controller ✅
**Priority:** P1  
**Estimated Time:** 6 hours  
**Dependencies:** Task 4.1

**Subtasks:**
- [x] Create `Customers.php` controller
- [x] Add `index()` method (list view)
- [x] Add `add()` method
- [x] Add `edit()` method
- [x] Add `delete()` method (soft delete)
- [x] Add `viewLedger()` method
- [x] Add `recordPayment()` method
- [x] Add `search()` AJAX method
- [x] Add `getCustomerInfo()` AJAX method

**Files to Create:**
- `application/controllers/Customers.php`

**Acceptance Criteria:**
- Can add/edit/delete customers
- Can view customer ledger
- Can record payments
- Search works correctly

---

### Task 4.3: Create Customer Management UI ✅
**Priority:** P1  
**Estimated Time:** 8 hours  
**Dependencies:** Task 4.2

**Subtasks:**
- [x] Create customers list view
- [x] Create add customer modal
- [x] Create edit customer modal
- [x] Create customer ledger view
- [x] Create record payment modal
- [x] Add customer search autocomplete
- [x] Display current balance prominently
- [x] Show credit limit warning
- [x] Add filter by status (active/blocked)

**Files to Create:**
- `application/views/customers/customers.php`
- `application/views/customers/customer_list.php`
- `application/views/customers/ledger.php`
- `public/js/customers.js`

**Acceptance Criteria:**
- UI is intuitive and responsive
- Search autocomplete works
- Ledger displays correctly
- Payment recording works

---

### Task 4.4: Integrate Credit Sales in POS ✅
**Priority:** P1  
**Estimated Time:** 4 hours  
**Dependencies:** Task 3.6, Task 4.2

**Subtasks:**
- [x] Add customer selection to POS screen (already done in 3.3)
- [x] Display customer balance (already done in 3.3)
- [x] Add "Credit" payment method (already done in 3.3)
- [x] Add "Partial Payment" option (already done in 3.3)
- [x] Validate credit limit before processing
- [x] Update customer balance after sale
- [x] Create ledger entry
- [x] Show credit info on receipt (receipt already includes payment status)

**Files to Modify:**
- `application/views/transactions/transactions.php`
- `application/controllers/Transactions.php`
- `public/js/pos.js`

**Acceptance Criteria:**
- Can select customer in POS
- Credit limit enforced
- Balance updates correctly
- Ledger entry created

---

## Phase 5: Reports and Printing

### Task 5.1: Install Thermal Printer Library ✅
**Priority:** P1  
**Estimated Time:** 2 hours  
**Dependencies:** None

**Subtasks:**
- [x] Install Composer if not present
- [x] Run `composer require mike42/escpos-php`
- [x] Test printer connectivity
- [x] Configure printer IP in .env

**Files to Modify:**
- `composer.json` (created if not exists)

**Verification:**
```bash
composer show mike42/escpos-php
```

---

### Task 5.2: Create Thermal Printer Library ✅
**Priority:** P1  
**Estimated Time:** 6 hours  
**Dependencies:** Task 5.1

**Subtasks:**
- [x] Create `Thermal_printer.php` library
- [x] Add `printReceipt()` method
- [x] Format receipt with shop info
- [x] Include IMEI numbers for serialized items
- [x] Include warranty information
- [x] Add trade-in details if applicable
- [x] Handle printer offline gracefully
- [x] Add fallback to PDF generation (placeholder)

**Files to Create:**
- `application/libraries/Thermal_printer.php`

**Acceptance Criteria:**
- Receipt prints correctly on thermal printer
- IMEI and warranty info included
- Handles printer offline scenario

---

### Task 5.3: Create Profit Reports ✅
**Priority:** P1  
**Estimated Time:** 6 hours  
**Dependencies:** Task 3.5

**Subtasks:**
- [x] Create `Reports.php` controller (modify existing)
- [x] Add daily profit report
- [x] Add monthly profit report
- [x] Add profit by category report
- [x] Add profit by staff report
- [x] Add profit by item report (covered in daily report)
- [x] Use profit_report view
- [x] Add date range filter
- [x] Add export to PDF option (print functionality)

**Files to Modify:**
- `application/controllers/Reports.php`

**Files to Create:**
- `application/views/reports/profit_daily.php`
- `application/views/reports/profit_monthly.php`

**Acceptance Criteria:**
- Reports display accurate profit data
- Date range filtering works
- Can export to PDF

---

### Task 5.4: Create Inventory Reports
**Priority:** P2  
**Estimated Time:** 4 hours  
**Dependencies:** Task 2.1

**Subtasks:**
- [x] Add low stock report




- [x] Add stock value report



- [x] Add IMEI status report



- [x] Add category-wise inventory report



- [x] Use inventory_available view



**Files to Create:**
- `application/views/reports/inventory_reports.php`

**Acceptance Criteria:**
- Reports show accurate inventory data
- Low stock alerts work
- Stock value calculated correctly

---

## Phase 6: Testing and Refinement

### Task 6.1: Unit Testing
**Priority:** P2  
**Estimated Time:** 8 hours  
**Dependencies:** All previous phases

**Subtasks:**
- [ ] Test Item model methods
- [ ] Test Transaction model methods
- [ ] Test Customer model methods
- [ ] Test profit calculations
- [ ] Test balance updates
- [ ] Test IMEI locking/unlocking

**Files to Create:**
- `tests/models/ItemTest.php`
- `tests/models/TransactionTest.php`
- `tests/models/CustomerTest.php`

---

### Task 6.2: Integration Testing
**Priority:** P2  
**Estimated Time:** 12 hours  
**Dependencies:** Task 6.1

**Subtasks:**
- [ ] Test complete sale flow (standard item)
- [ ] Test complete sale flow (serialized item)
- [ ] Test credit sale with balance update
- [ ] Test trade-in transaction
- [ ] Test payment recording
- [ ] Test receipt printing
- [ ] Test concurrent IMEI locking

---

### Task 6.3: User Acceptance Testing
**Priority:** P2  
**Estimated Time:** 16 hours  
**Dependencies:** Task 6.2

**Subtasks:**
- [ ] Create test scenarios document
- [ ] Conduct UAT with shop staff
- [ ] Document bugs and issues
- [ ] Fix critical bugs
- [ ] Retest fixed issues
- [ ] Get sign-off from stakeholders

---

### Task 6.4: Performance Optimization
**Priority:** P2  
**Estimated Time:** 8 hours  
**Dependencies:** Task 6.3

**Subtasks:**
- [ ] Optimize database queries
- [ ] Add missing indexes
- [ ] Implement query caching
- [ ] Optimize AJAX calls
- [ ] Minify JavaScript and CSS
- [ ] Test with large dataset (10,000+ transactions)

---

### Task 6.5: Documentation
**Priority:** P2  
**Estimated Time:** 8 hours  
**Dependencies:** All previous tasks

**Subtasks:**
- [ ] Create user manual
- [ ] Create admin manual
- [ ] Document API endpoints
- [ ] Create troubleshooting guide
- [ ] Create backup/restore guide
- [ ] Create video tutorials

**Files to Create:**
- `docs/USER_MANUAL.md`
- `docs/ADMIN_MANUAL.md`
- `docs/API_DOCUMENTATION.md`
- `docs/TROUBLESHOOTING.md`

---

## Summary

### Total Estimated Time: 150-180 hours (4-5 weeks)

### Phase Breakdown:
- **Phase 1**: ✅ Completed (8 hours)
- **Phase 2**: 22 hours (3 days)
- **Phase 3**: 38 hours (5 days)
- **Phase 4**: 22 hours (3 days)
- **Phase 5**: 18 hours (2.5 days)
- **Phase 6**: 52 hours (6.5 days)

### Priority Distribution:
- **P0 (Critical)**: 56 hours
- **P1 (High)**: 52 hours
- **P2 (Medium)**: 52 hours

---

**Document Version**: 1.0  
**Last Updated**: 2024-12-25  
**Status**: Ready for Implementation
